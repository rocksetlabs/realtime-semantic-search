# using os for env variables
import os

# rockset's python module
from rockset import *
from rockset.models import *

# i'm so pretty, oh so pretty
from pprint import pprint

# default globals
integration_name = "confluent_cloud_webinar_test"
collection_name = "video_game_embeddings_test"
workspace_name = "confluent_webinar"

# Confluent Cloud api key and secret and bootstrap servers
CC_API_KEY = os.getenv('CONFLUENT_CLOUD_API_KEY')
CC_API_SECRET = os.getenv('CONFLUENT_CLOUD_API_SECRET')
CC_BOOTSTRAP_SERVERS = os.getenv('CONFLUENT_CLOUD_BOOTSTRAP_SERVERS')

# Rockset api key
ROCKSET_API_KEY = os.getenv('ROCKSET_API_KEY')

# make sure to set the correct Rockset region you are using
region = Regions.usw2a1

# Create an instance of the Rockset client
rs = RocksetClient(api_key=ROCKSET_API_KEY, host=region)

# create our Confluent Cloud integration
api_response = rs.Integrations.create_kafka_integration(
    description="My event data from Confluent Cloud",
    kafka=KafkaIntegration(
        bootstrap_servers=CC_BOOTSTRAP_SERVERS,
        security_config=KafkaV3SecurityConfig(
            api_key=CC_API_KEY,
            secret=CC_API_SECRET,
        ),
        use_v3=True,
    ),
    name=integration_name
)

# see the response
pprint(api_response)

# our recommended ingest transformation
ingest_sql = '''
SELECT *
EXCEPT (_meta)
,"asin" as _id
,CASE
WHEN price is null then 30.00
ELSE price
END as estimated_price
,VECTOR_ENFORCE(embedding[1], 1536, 'float') as embedding
,ARRAY_REMOVE(TOKENIZE(brand), 'by') as brand_tokens
,TOKENIZE(description) as description_tokens
,'confluent_cloud' as origin
FROM _input
'''

# create our Rockset collection
api_response = rs.Collections.create_kafka_collection(
    name=collection_name,
    workspace=workspace_name,
    description="receives video game description embeddings",
    field_mapping_query=FieldMappingQuery(
        sql=ingest_sql,
    ),
    sources=[
        KafkaSourceWrapper(
            format_params=FormatParams(
                json=True
            
            ),
            integration_name=integration_name,
            kafka_topic_name="products.embeddings",
            offset_reset_policy="EARLIEST",
            use_v3=True,
        )
    ]
)

# see the response
pprint(api_response)

# Create Vector Search (Semantic Search) Query Lambda
vs_query = '''
SELECT
  asin,
  title,
  brand,
  description,
  estimated_price,
  brand_tokens,
  APPROX_DOT_PRODUCT(embedding, VECTOR_ENFORCE(:embedding, 1536, 'float')) as similarity
FROM {workspace_name}.{collection_name} v
WHERE estimated_price between :min_price AND :max_price
AND ARRAY_CONTAINS(brand_tokens, LOWER(:brand))
ORDER BY similarity DESC
LIMIT :limit;
'''.format(workspace_name=workspace_name, collection_name=collection_name)

# openai embedding for model="text-embedding-ada-002" and input="space wars"
space_wars_embedding = "[0.004105015192180872, -0.01179469097405672, -0.013379559852182865, -0.025793233886361122, -0.01870553568005562, -0.011332154273986816, -0.023766234517097473, -0.018827972933650017, -0.00039302883669734, -0.02206573076546192, 0.021222282201051712, 0.005295367445796728, 0.003778518410399556, -0.001254121190868318, 0.01271976437419653, 0.0035778589081019163, 0.019875483587384224, -0.014542704448103905, 0.010032969526946545, -0.012066771276295185, 0.0040642027743160725, 0.0033193824347108603, 0.023507757112383842, -0.001943675335496664, 0.004152629058808088, -0.018052542582154274, 0.008482110686600208, -0.015590214170515537, 0.003775117453187704, -0.029030991718173027, 0.029874442145228386, -0.029792817309498787, 0.007774701341986656, -0.013155093416571617, -0.019807463511824608, -0.015780670568346977, 0.011270935647189617, -0.01352920476347208, -0.0002175581466872245, -0.010930835269391537, 0.015100469812750816, 0.030092107132077217, 0.000497822358738631, 0.003540447913110256, -0.0376015305519104, -0.0032870729919523, 9.44842176977545e-05, -0.004931459669023752, 0.011087281629443169, 0.008121604099869728, 0.01820218749344349, 0.033710777759552, -0.044730037450790405, -0.009284747764468193, -0.008502516895532608, -0.008495714515447617, -0.02349415421485901, 0.021984107792377472, 0.016882596537470818, -0.011162104085087776, 0.00674419617280364, 0.01461072452366352, -0.015331737697124481, 0.029439114034175873, -0.016692141070961952, -0.001570414868183434, -0.010189415886998177, -0.012678952887654305, -0.007441402412950993, -0.00620343629270792, 0.03447260335087776, 0.023439737036824226, 0.015114073641598225, 0.0024674301967024803, -0.000613031443208456, -0.013604026287794113, 0.016039147973060608, -0.00402339082211256, -0.010441089980304241, 0.012019157409667969, 0.01870553568005562, -0.007318966090679169, -0.005268159322440624, 0.015263717621564865, 0.022786743938922882, 0.015699045732617378, -0.0005445861606858671, 0.020052334293723106, -0.030119314789772034, 0.0018994621932506561, 0.00526135740801692, -0.0076930769719183445, -0.002741211326792836, 0.02375262975692749, -0.02659587189555168, 0.01998431421816349, -0.0037819193676114082, 0.008897033520042896, 0.012284436263144016, -0.0456279031932354, 0.0035948639269918203, 0.021235885098576546, -0.02607891894876957, -0.01659691147506237, -0.009672462940216064, 0.007386986631900072, 0.01659691147506237, 0.020052334293723106, 0.026895159855484962, -0.00440430361777544, 0.011543016880750656, -0.002785424469038844, 0.00389075162820518, -0.02206573076546192, -0.005863335449248552, -0.018106959760189056, 0.0035166407469660044, 0.0015814680373296142, -0.008516120724380016, -0.023181261494755745, 0.03251362219452858, -0.009468402713537216, 0.01711386628448963, -0.004819226451218128, 0.02832358330488205, 0.009386777877807617, -0.026568664237856865, -0.005744300317019224, -0.003764914348721504, -0.009135103784501553, 0.018664725124835968, 0.03036418743431568, 0.01629762351512909, -0.02303161658346653, -0.027888255193829536, 0.007720285095274448, -0.007720285095274448, 0.029820026829838753, -0.017154676839709282, -0.020419644191861153, 0.01069276500493288, 0.025004200637340546, -0.013420372270047665, -0.001970883458852768, -0.017141073942184448, 0.015467777848243713, 0.017494777217507362, 0.014025751501321793, -0.0036594830453395844, 0.001125733251683414, 0.027575362473726273, -0.021222282201051712, 0.010066979564726353, 0.001498993718996644, 0.0103526646271348, 0.002596668666228652, -0.007046885788440704, 0.010828805156052113, -0.010910429060459137, -0.010039771907031536, 0.006856429390609264, -0.00901946984231472, 0.020596496760845184, 0.002418115735054016, 0.02171202562749386, 0.030282562598586082, 0.016664933413267136, 0.027888255193829536, -0.0228139515966177, -0.0036764880642294884, 5.5585202062502503e-05, 0.018174979835748672, -0.02692236937582493, 0.010386674664914608, 0.002037202939391136, 0.0339556485414505, 0.01090362761169672, 0.016501683741807938, -0.036567624658346176, -0.019657818600535393, -0.012876210734248161, 0.00477501330897212, 0.024201562628149986, 0.015236509963870049, -0.0035744579508900642, 0.0035200419370085, -0.001482838881202042, 0.006788409315049648, -0.0008783099474385381, -0.01900482550263405, 0.013692452572286129, 0.01723630167543888, -0.0016979525098577142, 0.001078119152225554, -0.680854320526123, -0.03447260335087776, 0.020800556987524033, -0.020501267164945602, 0.006029984913766384, 0.000953132112044841, 0.01964421384036541, 0.011638244614005089, -0.015318133868277073, 0.0034996357280761003, -0.013814888894557953, 0.00544161070138216, -0.016406456008553505, -0.0131482919678092, -0.011733473278582096, -0.0049110534600913525, 0.01183550339192152, -0.01976665109395981, 0.016855388879776, 0.013617630116641521, -0.01748117431998253, 0.03324824199080467, 0.007795107085257769, 0.001374006737023592, 0.012855805456638336, -0.0028109319973737, 0.0025626583956182003, 0.0009267742861993611, -0.031153220683336258, 0.009128301404416561, -0.015481382608413696, 0.024500852450728416, -0.003934964537620544, 0.001639285241253674, 0.04747805371880531, 0.00253545050509274, -0.02764338254928589, 0.025684401392936707, 0.022664308547973633, 0.0168145764619112, -0.015631025657057762, -0.006196633912622929, 0.0028908555395901203, 0.002086517633870244, -0.01671934872865677, 0.03221433609724045, 0.013651641085743904, -0.022433040663599968, -0.012243623845279217, -0.03667645528912544, 0.022963596507906914, 0.006819018162786961, 0.00384313752874732, 0.022745931521058083, 0.014039355330169201, 0.001113829668611288, 0.017685234546661377, -0.0225282683968544, 0.0055674477480351925, 0.021276697516441345, 0.001179299084469676, 0.03463585302233696, -0.0112845404073596, -0.005019885953515768, -0.014529100619256496, 0.027588965371251106, -0.0377647764980793, 0.00802637543529272, -0.00791754387319088, -0.027997085824608803, 0.011087281629443169, 0.02794267050921917, -0.018215792253613472, 0.00196918286383152, 0.018637515604496002, 0.029738401994109154, 0.027793025597929955, -0.020732536911964417, -0.014910013414919376, 0.008536526933312416, 0.011781087145209312, -0.010264238342642784, -0.03610508516430855, 0.004744404461234808, 0.03074510022997856, -0.015018844977021217, -0.031044388189911842, 0.021535174921154976, -0.00086810695938766, 0.005553843919187784, 0.011400174349546432, 0.024296792224049568, -0.01443387195467949, -0.02397029474377632, 0.008720180951058865, 8.84793098521186e-06, -0.005019885953515768, -0.0068292212672531605, 0.014569912105798721, -0.013223113492131233, -0.008155614137649536, -0.002052507596090436, 0.01240687258541584, -0.00017717118316795677, 0.001129134208895266, 0.0036594830453395844, -0.011509006842970848, 0.001042408519424498, 0.017413154244422913, -0.02684074454009533, 0.007849522866308689, 0.009516016580164433, -0.016855388879776, 0.005649072118103504, -0.0018739546649158, -0.027888255193829536, 0.031398091465234756, 0.00791754387319088, 0.004567551892250776, -0.02553475834429264, 0.020093146711587906, -0.02116786502301693, 0.0013093875022605062, -0.009305153973400593, 0.0016937012551352382, 0.007910741493105888, 0.007999167777597904, -0.022174563258886337, -0.023684609681367874, -0.001751518459059298, -0.0032411592546850443, 0.000495271582622081, 0.018011732026934624, 0.01348839234560728, 0.004996078554540873, -0.007359778508543968, 0.0009879923891276121, -0.013046261854469776, -0.0055334377102553844, -0.01271976437419653, -0.011726670898497105, 0.01663772389292717, -0.009094291366636753, 0.0009386778110638261, 0.0046083638444542885, -0.023562174290418625, -0.034146107733249664, -0.015821482986211777, -0.015617422759532928, 0.0007822315092198551, -0.00997175183147192, 0.0028823530301451683, -0.009692869149148464, -0.002622176194563508, 0.017331529408693314, -0.001459882128983736, -0.009114697575569153, -0.012400070205330849, -0.010134999640285969, -0.03496234863996506, 0.005404199473559856, -0.0032819714397192, -0.00648912088945508, -2.5945961169782095e-05, 0.009822106920182705, -0.018515080213546753, -0.007713483180850744, 0.011359361931681633, -0.01862391270697117, -0.019753046333789825, 0.00916231144219637, -0.008883429691195488, -0.00253034895285964, 0.031017180532217026, -0.01769883930683136, 0.01348158996552229, -0.0061286138370633125, 0.006676176097244024, 0.002513343933969736, 0.006652369163930416, -0.00034626497654244304, 0.00935276784002781, -0.01824299991130829, 0.008346070535480976, 0.00395877193659544, 0.016270415857434273, 0.016542496159672737, 0.015263717621564865, -0.002885754220187664, 0.006410897709429264, -0.010257435962557793, 0.021684817969799042, -0.003645879216492176, -0.009386777877807617, 0.001092573394998908, -0.008210030384361744, -0.00582252349704504, -0.001952177844941616, 0.023126844316720963, 0.02010675147175789, 0.02485455572605133, -0.015780670568346977, 0.018664725124835968, -0.0060775987803936005, 0.018637515604496002, -0.03479909896850586, -0.018555892631411552, -0.028459623456001282, 0.021902482956647873, 2.821772613970097e-05, 0.012427277863025665, 0.002574562095105648, -0.00024147146905306727, -0.00080986472312361, 0.03240479156374931, 0.015943918377161026, -0.008584140799939632, 0.000514827377628535, -0.02206573076546192, 0.011971543543040752, -0.01990269124507904, -0.009856116957962513, 0.006614957936108112, 0.0012362658744677901, -0.03335707262158394, 0.012393267825245857, 0.023507757112383842, 0.027371302247047424, 0.011114489287137985, -0.021943295374512672, -0.002436821348965168, 0.0051015098579227924, -0.020011523738503456, 0.00880860723555088, 0.014923617243766785, 0.009243936277925968, 0.012087177485227585, -0.011277738027274609, 0.03052743524312973, 0.0023432935122400522, 0.010658754967153072, 0.013352352194488049, 0.04010466858744621, -0.005683082155883312, -0.00039047806058079004, 0.0003288348380010575, 0.03964213281869888, 0.005183134227991104, -0.020555684342980385, 0.0005564896855503321, -0.029194241389632225, -0.012801389209926128, -0.005087906029075384, 0.001731962664052844, 0.013903315179049969, -0.024582475423812866, -0.001414818805642426, -0.011236925609409809, 0.010740378871560097, 0.019018428400158882, 0.004989276640117168, 0.010237029753625393, 0.004458719864487648, -0.0062680551782250404, -0.006635364145040512, -0.003004789352416992, -0.008284851908683777, 0.010066979564726353, 0.000754598353523761, -0.0021613396238535643, 0.004346486646682024, -0.014665140770375729, 0.007720285095274448, -0.03352032229304314, -0.004390699788928032, -0.007067291997373104, 0.014787577092647552, -0.012087177485227585, 0.000441705749835819, 0.0131482919678092, 0.01424341555684805, -0.020991012454032898, 0.016583308577537537, 0.011563422158360481, -0.01697782427072525, -0.019467361271381378, -0.0284868311136961, -0.005968766752630472, -0.008570536971092224, 0.020269999280571938, -0.019494570791721344, 0.0032632658258080482, 0.00169115059543401, -0.010080583393573761, -0.027085617184638977, -0.018977617844939232, 0.0187191404402256, -0.008645358495414257, 0.01141377817839384, 0.00884941965341568, -0.008556933142244816, 0.03357473760843277, -0.010427486151456833, -0.010992053896188736, 0.020610099658370018, 0.0031850426457822323, -0.00014751865819562227, -0.03305778279900551, 0.00126262370031327, -0.015331737697124481, 0.0028432414401322603, -0.013780878856778145, -0.004533541854470968, 0.013420372270047665, 0.011026063933968544, -0.00271570379845798, -0.0206645168364048, -0.028650080785155296, 0.02954794652760029, 0.01841985248029232, 0.009509214200079441, -0.03082672320306301, -0.01968502625823021, -0.009196321479976177, 0.08537887036800385, 0.0006279108347371221, 0.010298248380422592, 0.011713067069649696, 0.016120770946145058, -0.020351624116301537, -0.019317718222737312, -0.0018943606410175562, 0.020174771547317505, -0.016542496159672737, -0.0112641341984272, -0.001203106134198606, 0.018814368173480034, -0.010155405849218369, 0.006601354107260704, 0.01705944910645485, 0.0061728269793093204, 0.001530452980659902, 0.00379552342928946, -0.009482006542384624, 0.00200659385882318, -0.00665917107835412, -0.014012147672474384, 0.01331834215670824, 0.024269582703709602, -0.026623079553246498, 0.012794586829841137, 0.025847651064395905, -0.002220857422798872, -0.03534325957298279, -0.015767067670822144, -0.006179628893733025, 0.00012158598838141188, 0.010815201327204704, 0.008584140799939632, 0.00545181380584836, 0.009903731755912304, 0.025425925850868225, 0.012896616943180561, -0.022120147943496704, -0.00401318771764636, 0.01480118092149496, -0.00070145761128515, -0.014093771576881409, 0.009475204162299633, -0.0018195385346189141, -0.0056456709280610085, 0.03425493836402893, 0.002957175252959132, -0.02405191957950592, 0.027656985446810722, 0.000284834299236536, -0.015100469812750816, -0.02726246975362301, -0.011638244614005089, 0.019358530640602112, -0.01705944910645485, -0.008869824931025505, -0.008822211064398289, -0.0187599528580904, -0.009325560182332993, -0.011774284765124321, 0.022215375676751137, 0.011066875420510769, -0.016746556386351585, -0.027003992348909378, -0.0047716121189296246, -0.01141377817839384, -0.004506333731114864, -0.000735467707272619, -0.014311435632407665, -0.00957043282687664, -0.004016588907688856, -0.012413674034178257, 0.017453966662287712, -0.013536006212234497, 0.017535589635372162, -0.013780878856778145, 0.004057400859892368, 0.013039459474384785, -0.006642166059464216, -0.0051661292091012, -0.00133404484950006, -0.028595663607120514, 0.00581232039257884, 0.0015474579995498061, 0.008822211064398289, 0.014950824901461601, 0.0010934235760942101, 0.001068766345269978, 0.016107168048620224, 0.001694551552645862, 0.005968766752630472, -0.00590754859149456, 0.0243512075394392, 0.002475932938978076, 0.0036424780264496803, -0.002050807001069188, 0.00972007680684328, 0.01778046227991581, -0.00768627505749464, -0.019072845578193665, -0.003399306209757924, -0.004727399442344904, 0.002894256729632616, 0.001863751676864922, 0.011461392045021057, 0.007033281493932009, -0.01637924835085869, 0.008842617273330688, -0.013175499625504017, -0.03235037624835968, 0.010876419022679329, -0.02286836877465248, 0.009101093746721745, 0.009890126995742321, 0.005417803768068552, 0.01824299991130829, -0.007475412450730801, 0.007366580422967672, -0.01556300651282072, -0.030092107132077217, -0.010536318644881248, 0.017984522506594658, 0.00010537806520005688, -0.007944751530885696, -0.000932726077735424, -0.01892320066690445, -0.009686066769063473, 0.01252930797636509, -0.035588134080171585, 0.016147978603839874, 0.005635467823594809, 0.0073393722996115685, -0.008346070535480976, -0.011563422158360481, -0.00143182382453233, 0.002979281824082136, 0.002542252419516444, 0.0031544335652142763, -0.03814569115638733, -0.0015449072234332561, 0.00897185504436493, -0.024378415197134018, 0.009094291366636753, -0.01786208711564541, -0.015522194094955921, 0.009686066769063473, -0.017902899533510208, 0.0056626759469509125, -0.014569912105798721, 0.0039247614331543446, -0.002836439525708556, -0.009005866013467312, -0.0028228354640305042, -0.03849939629435539, -0.015522194094955921, -0.029112616553902626, 0.029711194336414337, 0.019113657996058464, 0.03052743524312973, 0.008760993368923664, 0.02968398667871952, -0.017916502431035042, 0.017127469182014465, -0.021902482956647873, 0.004200243391096592, -0.0038193303626030684, -0.014882804825901985, 0.018977617844939232, 0.028269167989492416, 0.012298040091991425, 0.005458615720272064, -0.011774284765124321, 0.026432624086737633, 0.022473851218819618, -0.019154468551278114, 0.01595752313733101, -0.007903939113020897, -0.022038523107767105, -0.00897865742444992, -0.01617518812417984, -0.010447892360389233, -0.014733160845935345, -0.014787577092647552, -0.021154262125492096, 0.002850043587386608, 0.011155301705002785, 0.009828909300267696, -0.0084685068577528, 0.020678119733929634, -0.0065265316516160965, 0.02954794652760029, 0.000180359638761729, 0.021657610312104225, -0.0044009024277329445, -0.001282179495319724, -0.013556412421166897, -0.0026833941228687763, -0.007169322110712528, 0.002941870829090476, -0.0032666667830199003, -0.0076930769719183445, 0.014393060468137264, 0.00479541951790452, 0.02886774390935898, -0.011209717951714993, 0.001430973527021706, -0.009733680635690689, -0.03697574511170387, -0.01333874836564064, -0.022460248321294785, -0.004652576986700296, -0.04418587684631348, -0.009638452902436256, -0.00200659385882318, -0.001965781906619668, 0.012434080243110657, -0.026350999251008034, -0.014338644221425056, 0.018474267795681953, -0.00205420795828104, 0.005502828862518072, 0.007747493218630552, 0.03844497725367546, 0.00600277679041028, 0.000663621409330517, -0.010536318644881248, -0.009216727688908577, -0.024881765246391296, -0.0059211524203419685, 0.02810591831803322, 0.020555684342980385, -0.017086656764149666, 0.016692141070961952, -0.01643366366624832, -0.0037513102870434523, -0.02922144904732704, -0.034146107733249664, 0.008142010308802128, -0.015086865052580833, 0.026731912046670914, -0.023018013685941696, -0.012338852509856224, -0.04432191699743271, 0.02688155695796013, 0.0025116433389484882, -0.002945271786302328, -0.008550130762159824, -0.02074613980948925, -0.0054382095113396645, 0.00507090101018548, 6.329060852294788e-05, 0.02206573076546192, 0.003860142547637224, -0.033683568239212036, 0.008475308306515217, -0.007958355359733105, -0.004145827144384384, 0.000775004387833178, 0.0026238765567541122, 0.023657402023673058, -0.017984522506594658, -0.0002348820271436125, 0.013393163681030273, 0.009692869149148464, -0.01778046227991581, -0.007108103949576616, 0.015549402683973312, 0.02734409272670746, -0.028894951567053795, -0.0008234687265940011, 0.00248783640563488, -0.006169426254928112, 0.02772500552237034, -0.014161791652441025, -0.013998542912304401, -0.0131074795499444, -0.01252930797636509, -0.0065775467082858086, 0.011556620709598064, 0.00810800027102232, -0.006417699623852968, -0.028949368745088577, -0.024949785321950912, -0.0033108799252659082, -0.007352976128458977, 0.003921360708773136, 0.006281659472733736, -0.013774076476693153, -0.018895993009209633, 0.01178788859397173, -0.035125598311424255, -0.0008706576772965491, 0.003093215636909008, 0.0033618949819356203, 0.016243208199739456, 0.03942446783185005, -0.016569703817367554, 0.013556412421166897, -0.0031034185085445642, 0.030010482296347618, -0.007523026783019304, 0.02824195846915245, 0.00506069790571928, -0.02900378406047821, 0.02324928157031536, -0.03158855065703392, -0.0023994101211428642, 0.024840952828526497, 0.013556412421166897, -1.0555077096796595e-05, 0.005196738056838512, 0.007346174214035273, 0.02358938194811344, 0.04029512777924538, -0.0061082080937922, -0.030935555696487427, -0.016025543212890625, 0.01621600054204464, 0.014855597168207169, 0.012379663996398449, 0.014188999310135841, -0.03640437498688698, 0.014474684372544289, -0.025629986077547073, 0.022582683712244034, 0.006434704642742872, -0.035043973475694656, 0.009325560182332993, -0.0014216207200661302, 0.007529828697443008, 0.002979281824082136, -0.03425493836402893, -0.024827348068356514, 0.00201679696328938, -0.015603817999362946, 0.025289885699748993, 0.014814784750342369, -0.007455006707459688, 0.008522922173142433, 0.016841784119606018, 0.019508173689246178, -0.004186639096587896, -0.003744508372619748, 0.007604650687426329, -0.01028464362025261, -0.017549194395542145, -0.012209613807499409, -0.006757800001651049, 0.004581155721098185, 0.018664725124835968, 0.002945271786302328, -0.004485927522182465, -0.006951657589524984, -0.007108103949576616, -0.011543016880750656, 0.019018428400158882, -0.007196530234068632, 0.008958251215517521, 0.04345126077532768, 0.013250322081148624, 0.004601561930030584, 0.018950408324599266, 0.014597120694816113, -0.012400070205330849, 0.0034792297519743443, -0.010767587460577488, 0.005557244643568993, -0.00645851157605648, 0.008488912135362625, 0.011100885458290577, -0.029058201238512993, -0.00497567281126976, -0.0004249132762197405, 0.02659587189555168, 0.0069244494661688805, 0.001282179495319724, 0.006601354107260704, -0.006740794982761145, -0.012733369134366512, 0.004156030248850584, -0.004635571967810392, 0.014325040392577648, 0.0018586501246318221, -0.03218712657690048, 0.012093979865312576, -0.004190040286630392, 0.01010098960250616, -0.01673295348882675, 0.0008893632330000401, 0.012352456338703632, -0.013828492723405361, -0.0021528371144086123, 0.011393371969461441, -0.01837904006242752, -4.7374960558954626e-05, -0.028214750811457634, 0.03496234863996506, -0.014134583994746208, 0.001863751676864922, 0.015440570190548897, 0.03545209392905235, -0.008060385473072529, -0.02447364293038845, -0.0037887212820351124, 0.010685962624847889, 0.012644942849874496, -0.0022871769033372402, -0.008019573986530304, 0.001334895147010684, 0.010271039791405201, 0.006067395675927401, -0.034608643501996994, 0.0038023253437131643, -0.027194449678063393, 0.022120147943496704, -0.014692348428070545, 0.03316661715507507, 0.0017047545406967402, -0.012583724223077297, 0.002860246691852808, -0.00318164168857038, -0.00115379155613482, -0.009434392675757408, -7.115543849067762e-05, 0.010393476113677025, 0.004907652735710144, 0.00461516622453928, 0.0049110534600913525, -0.00810800027102232, -0.01216880138963461, 0.007584244944155216, 0.023915879428386688, 0.009488808922469616, 0.03422773256897926, 0.20841369032859802, 0.0011240326566621661, 0.004826028365641832, 0.04266222566366196, 0.00323945889249444, 0.016950616613030434, 0.023602986708283424, -0.0071829259395599365, -0.011549818329513073, 0.013427174650132656, -0.022215375676751137, 0.013944127596914768, 0.010427486151456833, -0.009026271291077137, 0.001645236974582076, -0.012121187523007393, -0.023616589605808258, -0.01537255011498928, -0.017521986737847328, -0.000749496859498322, 0.011114489287137985, -0.011440986767411232, -0.013808086514472961, -0.01575346291065216, -0.003540447913110256, -0.0069924695417284966, -0.0020406038966029882, -0.022215375676751137, 0.014773973263800144, 0.02840520814061165, -0.009917335584759712, 0.00458455691114068, 0.0038669444620609283, -0.00740059046074748, -0.01591671071946621, 0.0002467855520080775, 0.006063994951546192, -0.008094395510852337, 0.007380184251815081, -0.009073886089026928, -0.016392851248383522, 0.0093391640111804, -0.0063972934149205685, 0.020079543814063072, -0.005159327294677496, 0.00978129543364048, -0.024364812299609184, 0.009386777877807617, 0.01391011755913496, 0.012093979865312576, -0.04029512777924538, -0.015726255252957344, 0.04225410521030426, 0.05466097965836525, -0.01846066489815712, 0.0076590669341385365, 0.005815721116960049, 0.011651848442852497, -0.00384313752874732, 0.014760368503630161, -0.002940170234069228, 0.02718084491789341, -0.021371925249695778, 0.01107367780059576, -0.000699757132679224, 0.011352560482919216, -0.000790308928117156, 0.020433247089385986, 0.03874426707625389, -0.008162415586411953, -0.01183550339192152, -0.028214750811457634, -0.02565719373524189, -0.02062370441854, -0.025970086455345154, -0.01723630167543888, 0.019970711320638657, -0.010740378871560097, -0.0073393722996115685, 0.005747701041400433, 0.002268471522256732, -0.0341188982129097, 0.0034996357280761003, -0.013501996174454689, -0.00861815083771944, -0.028677288442850113, -6.807327008573338e-05, 0.003826132509857416, -0.016909804195165634, 0.025412321090698242, -0.01671934872865677, -0.01028464362025261, -0.0094003826379776, -0.017726046964526176, 0.006866632495075464, -0.005676280241459608, 0.0375199057161808, 0.03836335614323616, -0.014501892030239105, -0.015127677470445633, -0.025208260864019394, -0.006965261418372393, 0.0342005230486393, 0.009998959489166737, -0.003911157604306936, -0.0021307305432856083, -0.004030192736536264, 0.017345134168863297, -0.012570120394229889, 0.006019781809300184, 0.0017787264660000801, -0.0186783280223608, 0.014923617243766785, -0.012311643920838833, -0.006152420770376921, 0.02954794652760029, -0.006043588742613792, -0.008033177815377712, 0.03836335614323616, -0.023684609681367874, -0.005407600663602352, 0.0012575221480801702, 0.02577963098883629, -0.014311435632407665, -0.007455006707459688, -0.023548569530248642, -0.03722061589360237, 0.0022956794127821922, -0.01014180202037096, -0.04111136868596077, 0.005098109133541584, -0.011753878556191921, -0.009985355660319328, -0.012604130432009697, -0.013787681236863136, 0.0015296026831492782, -0.007679473143070936, 0.02260989136993885, 0.004887246526777744, 0.0016554399626329541, 0.0036900921259075403, -0.003298976458609104, -0.0112233217805624, 0.03286732733249664, 0.01697782427072525, -0.012311643920838833, 0.011189311742782593, -0.006703384220600128, 0.016420060768723488, -0.017902899533510208, -0.012638140469789505, -0.007366580422967672, -0.0032938749063760042, -0.016066355630755424, 0.01591671071946621, -0.02294999361038208, -0.02477293275296688, -0.026282979175448418, -0.023657402023673058, 0.02497699297964573, -0.052565958350896835, 0.014787577092647552, 0.031262051314115524, -0.016624120995402336, -0.023480549454689026, -0.010828805156052113, -0.17750534415245056, 0.021358322352170944, 0.009937741793692112, -0.0058531323447823524, 0.016787368804216385, 0.008910637348890305, -0.005159327294677496, 0.008522922173142433, -0.005407600663602352, -0.004567551892250776, 0.011930731125175953, 0.009175916202366352, -0.036431584507226944, -0.008080791682004929, 0.027330489829182625, 0.024990595877170563, -0.008631754666566849, 0.012883013114333153, -0.01914086565375328, 0.005043692886829376, 0.041056953370571136, -0.022433040663599968, -0.0026884956751018763, -0.004380496684461832, 0.009563630446791649, -0.019916294142603874, -0.002406212268397212, 0.029411904513835907, -0.0056184628047049046, 0.00403359392657876, -0.01998431421816349, -0.012563318945467472, 0.04775013402104378, 0.01850147545337677, 0.00859774462878704, 0.002341593150049448, -0.017154676839709282, 0.00019141290977131575, -0.01820218749344349, 0.037193410098552704, 0.006121811922639608, 0.013522402383387089, 0.004897449631243944, -0.016841784119606018, -0.014637932181358337, -0.006710186135023832, -0.006635364145040512, 0.004570953082293272, 0.0006861530710011721, -0.011257331818342209, -0.01367204636335373, -0.017875690013170242, -0.01643366366624832, -0.0017583203734830022, 0.018691932782530785, 0.004088010173290968, 0.017685234546661377, 0.000665321946144104, 0.012338852509856224, -0.009822106920182705, -0.029194241389632225, -0.01160423457622528, 0.004778414499014616, -0.027656985446810722, -0.030119314789772034, -0.00458455691114068, -0.011107687838375568, -0.001863751676864922, -0.018311019986867905, 0.023698214441537857, 0.00591775169596076, 0.012379663996398449, 0.017032241448760033, -0.018610307946801186, 0.012835399247705936, 0.0003481780586298555, -0.008917439728975296, 0.009175916202366352, -0.01537255011498928, 0.013073469512164593, -0.01556300651282072, 0.02954794652760029, 0.022242583334445953, -0.011236925609409809, 0.013066667132079601, 0.014107375405728817, -0.016420060768723488, -0.010835607536137104, -0.016284020617604256, -0.02319486439228058, 0.016528891399502754, -0.01922248862683773, -0.00808759406208992, -0.006723789963871241, 0.0053769913502037525, 0.021059032529592514, 0.0013331945519894361, -0.004900850355625153, 0.01655610091984272, -0.000603253545705229, 0.003309179563075304, -0.004326080437749624, -0.015290926210582256, 0.008713378570973873, 0.017372341826558113, 0.01786208711564541, 0.008427694439888, 0.016243208199739456, 0.026663891971111298, -0.007604650687426329, -0.009611244313418865, 0.010617942549288273, 0.022324208170175552, 0.02459608018398285, 0.022337811067700386, 0.016229603439569473, 0.011128094047307968, -0.01031185220927, 0.030799515545368195, 0.011107687838375568, 0.04573673754930496, -0.003083012532442808, -0.016161583364009857, -0.010012563318014145, 0.000279520230833441, -0.009101093746721745, -0.08902475237846375, -0.026187751442193985, 0.021535174921154976, 0.017005033791065216, -0.018691932782530785, 0.015481382608413696, -0.010012563318014145, 0.010842408984899521, -0.022501060739159584, 0.020678119733929634, 0.003066007513552904, -0.05117834731936455, -0.009788096882402897, -0.014080167748034, 0.02802429534494877, -0.016324831172823906, -0.012624536640942097, -0.002327989088371396, -0.005193337332457304, 0.028595663607120514, 0.0084072882309556, -0.002095020143315196, 0.0029775812290608883, -0.00863855704665184, -0.011617838405072689, 0.00583272660151124, -0.03060906007885933, 0.03205108642578125, 0.018093355000019073, -0.009135103784501553, -0.005842929240316153, 0.0013638036325573921, 0.009325560182332993, -0.02014756388962269, -0.0168145764619112, -0.010019365698099136, 0.001158042810857296, -0.02062370441854, 0.0064653134904801846, -0.0456279031932354, 0.0015364047139883041, 0.03479909896850586, -0.006771404296159744, -0.019399341195821762, -0.01310067716985941, -0.007869929075241089, 0.003402707166969776, 0.01178788859397173, 0.000671273679472506, -0.02421516738831997, -0.05534118041396141, -0.034527018666267395, -0.029411904513835907, -0.02367100678384304, 0.015059657394886017, -0.006570744793862104, 0.016692141070961952, 0.004897449631243944, -0.00395877193659544, -0.004067603964358568, -0.009026271291077137, 0.02802429534494877, -0.01556300651282072, 0.013774076476693153, 0.000543735921382904, -0.012352456338703632, -0.026609476655721664, -0.02133111283183098, 0.008434496819972992, 0.008584140799939632, -0.035833004862070084, 0.010196218267083168, -0.03107159584760666, -0.0051015098579227924, -0.03381960839033127, -0.024881765246391296, 0.00412882212549448, -0.0150324497371912, 0.04391379654407501, -0.004370293579995632, -0.017753254622220993, -0.012461287900805473, 0.012536110356450081, -0.020378831773996353, 0.04021350294351578, 0.024201562628149986, 0.000219152367208153, 0.01257692277431488, 0.010964845307171345, -0.008876627311110497, -0.004036994650959969, 0.00952962040901184, 0.014229811728000641, -0.046335313469171524, 0.007006073836237192, 0.006074198056012392, 0.0016639424720779061, 0.004713795147836208, 0.002020197920501232, 0.0012039563152939081, -0.026187751442193985, 0.010441089980304241, -0.06007537990808487, 0.03069068305194378, 0.002936769276857376, 0.008454902097582817, -0.00142672227229923, -0.001237966469489038, 0.007080895826220512, -0.011692660860717297, -0.00014103548892308027, 0.013209509663283825, -0.004278466571122408, 0.006472115404903889, -0.00030439009424299, -0.008271248079836369, -0.02433760277926922, -0.003921360708773136, 0.022977201268076897, 0.0049790735356509686, 0.014338644221425056, -0.010094188153743744, -0.007332570385187864, 0.019535381346940994, 0.024650495499372482, 0.007720285095274448, -0.0076930769719183445, -0.0046253688633441925, -0.000647041539195925, -0.0020746139343827963, -0.015848690643906593, -0.028976576402783394, 0.0030081903096288443, -0.025262678042054176, -0.03485351428389549, 0.019467361271381378, -0.01085601281374693, -0.020922992378473282, 0.001274527283385396, -0.000748221471440047, 0.026010898873209953, 0.03458143398165703, -0.01769883930683136, -0.015168489888310432, 0.009584036655724049, 0.004809023346751928, 0.0064313034527003765, 0.02938469685614109, 0.011345758102834225, 0.016855388879776, 0.008543328382074833, -0.0060775987803936005, -0.0067850081250071526, 0.025167448446154594, 0.009026271291077137, -0.022963596507906914, -0.031180428341031075, -0.018555892631411552, 0.037574321031570435, 0.005543640814721584, 0.007720285095274448, 0.00263067870400846, 0.011998751200735569, 0.03662203997373581, 0.026527851819992065, -0.016909804195165634, -0.002486135810613632, -0.006795211229473352, 0.007352976128458977, -0.00201679696328938, 0.007883533835411072, -0.029139824211597443, 0.002353496616706252, -0.000672974216286093, -0.00108237040694803, -0.0015840188134461641, -0.007740691304206848, 0.002061010105535388, 0.027997085824608803, 0.003975776955485344, -0.018447060137987137, 0.008114801719784737, 0.016460871323943138, -0.00882901344448328, -0.039234012365341187, 0.01274697296321392, 0.010917231440544128, 0.028160335496068, -0.00371049833483994, 0.016188791021704674, -0.003904355689883232, 0.005873538553714752, -0.016651328653097153, -0.013467986136674881, -0.015263717621564865, -0.005291966255754232, -0.013012251816689968, 0.02591567113995552, -0.0112437279894948, 0.008250841870903969, 0.02299080416560173, 0.01424341555684805, 0.00732576847076416, 0.001068766345269978, 0.006985667627304792, -0.012073573656380177, -0.02116786502301693, 0.004802221432328224, -0.015848690643906593, -0.0037036961875855923, 0.007625056896358728, 0.012141593731939793, 0.03196946159005165, 0.024949785321950912, -0.019045637920498848, 0.0013612528564408422, 0.001998091349378228, 0.023915879428386688, 0.000106866005808115, -0.022936388850212097, -0.017549194395542145, 0.012651744298636913, 0.02214735560119152, 0.03920680284500122, -0.008264445699751377, -0.031017180532217026, 0.03496234863996506, 0.02104542963206768, 0.019589798524975777, -0.008033177815377712, -0.014488288201391697, 0.020256396383047104, 0.012563318945467472, -0.02299080416560173, -0.002072913572192192, 0.010203019715845585, 0.0012813291978091002, 0.004370293579995632, -0.010563526302576065, 0.015821482986211777, -0.03966934233903885, 0.051586467772722244, 0.02010675147175789, 0.0060333856381475925, 0.017372341826558113, -0.03335707262158394, 1.3617312106362078e-05, 0.02290918119251728, -0.011638244614005089, -0.013801285065710545, -0.02739850990474224, -0.000441705749835819, -0.013767275027930737, 0.026051711291074753, -0.013998542912304401, 0.00391795951873064, -0.004638973157852888, -0.023657402023673058, 0.017045844346284866, -0.022555476054549217, -0.02036522701382637, 0.026568664237856865, -0.0008039129315875471, 0.028377998620271683, 0.002125629223883152, -0.011692660860717297, -0.004094812087714672, 0.015780670568346977, 0.00489064771682024, 0.004431511741131544, -0.02714003250002861, -0.021916085854172707, -0.01786208711564541, -0.024024710059165955, -0.01934492588043213, 0.005995974875986576, 0.023276489228010178, -0.0003685840929392725, -0.012461287900805473, 0.013740066438913345, 0.005383793730288744, 0.0050402916967868805, 0.015644630417227745, -0.02048766426742077, -0.03245920687913895, 0.023303696885704994, 0.00183144211769104, -0.00637348648160696, 0.0007898837793618441, -0.00978129543364048]"

api_response = rs.QueryLambdas.create_query_lambda(
    name="find_related_game_vs_test",
    workspace=workspace_name,
    sql=QueryLambdaSql(
        query=vs_query,
        default_parameters=[
            QueryParameter(
                name="brand",
                type="string",
                value="playstation",
            ),
            QueryParameter(
                name="embedding",
                type="array",
                value=space_wars_embedding,
            ),
            QueryParameter(
                name="limit",
                type="int",
                value="10",
            ),
            QueryParameter(
                name="max_price",
                type="float",
                value="50",
            ),
            QueryParameter(
                name="min_price",
                type="float",
                value="0",
            )
        ]
    )
)
pprint(api_response)

# Create Full Text Search Query Lambda
fts_query = '''
SELECT
  asin,
  title,
  brand,
  description,
  estimated_price,
  brand_tokens,
  SCORE() AS text_search_score
FROM {workspace_name}.{collection_name} v
WHERE estimated_price between :min_price AND :max_price
AND ARRAY_CONTAINS(brand_tokens, LOWER(:brand))
AND SEARCH(
    HAS_TERM(description_tokens, :term1),
    HAS_TERM(description_tokens, :term2)
) OPTION(match_all=false)
ORDER BY text_search_score DESC, estimated_price ASC
LIMIT :limit;
'''.format(workspace_name=workspace_name, collection_name=collection_name)

api_response = rs.QueryLambdas.create_query_lambda(
    name="find_related_games_fts_test",
    workspace=workspace_name,
    sql=QueryLambdaSql(
        query=fts_query,
        default_parameters=[
            QueryParameter(
                name="brand",
                type="string",
                value="playstation",
            ),
            QueryParameter(
                name="limit",
                type="int",
                value="10",
            ),
            QueryParameter(
                name="max_price",
                type="float",
                value="50",
            ),
            QueryParameter(
                name="min_price",
                type="float",
                value="0",
            ),
            QueryParameter(
                name="term1",
                type="string",
                value="space",
            ),
            QueryParameter(
                name="term2",
                type="string",
                value="wars",
            )
        ]
    )
)
pprint(api_response)